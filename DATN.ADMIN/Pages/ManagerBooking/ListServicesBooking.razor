@page "/ListServicesBooking"
@using System.Net.Http.Json
@using DATN.ADMIN.IServices
@using DATN.Data.Enum
@using DATN.Utilites
@using DATN.ViewModels.Common
@using DATN.ViewModels.DTOs.Authenticate
@using DATN.ViewModels.DTOs.Booking
@using DATN.ViewModels.Enum
@inject HttpClient httpClient
@inject ISnackbar Snackbar
@inject IDialogService _dialogservice;
@inject IAddressService _addressServive;
<PageTitle>Danh sách đặt dịch vụ</PageTitle>
<MudText Typo="Typo.h4" Style="text-align:center">Danh sách đặt dịch vụ</MudText>
<MudButton Variant="Variant.Filled" Style="margin-bottom:10px" StartIcon="@Icons.Material.Filled.RemoveRedEye" Color="Color.Primary" OnClick="@ExpandAllGroups">Mở hết danh sách</MudButton>
<MudButton Variant="Variant.Filled" Style="margin-bottom:10px" StartIcon="@Icons.Material.Filled.RemoveRedEye" Color="Color.Primary" OnClick="@(async()=>await OpenDialogCreateBooking())">Đặt dịch vụ</MudButton>
<MudDataGrid Items="@lstBookingServices" Hover="true" Filterable="true" @ref="dataGrid" Hideable="true" Groupable="true" GroupExpanded="false" MultiSelection="true">
    <ToolBarContent>
        <MudSpacer />
    </ToolBarContent>
    <Columns>
        <TemplateColumn Title="Ngày" Grouping GroupBy="@_groupBy" Sortable="false" Filterable="false">
            <GroupTemplate>
                <span style="font-weight:bold">@context.Grouping.Key</span>
            </GroupTemplate>
        </TemplateColumn>
        <PropertyColumn Property="x=>x.NameGuest" Title="Tên khách hàng" Sortable="false" Filterable="false" />
        <PropertyColumn Property="x=>x.PhoneNumber" Title="SĐT" Sortable="false" Filterable="false" />
        <TemplateColumn Title="Địa chỉ" Sortable="false" Filterable="false">
            <CellTemplate>
                <span DataLabel="Địa chỉ">@(_addressServive.GetAddress(context.Item.Address!) ?? "Không có địa chỉ")</span>
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Thời gian đặt" Sortable="false" Filterable="false">
            <CellTemplate>
                <span>
                    @context.Item.BookingTime.ToString("dd/MM/yyyy HH:mm")
                </span>
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Trạng thái" Sortable="false" Filterable="false">
            <CellTemplate>
               @context.Item.Status
            </CellTemplate>
        </TemplateColumn>
        <PropertyColumn Property="x=>x.Id" Title="Hành động" Filterable="false" Sortable="false">
            <CellTemplate>
                <span>
                    <MudButtonGroup Variant="Variant.Filled">
                        <MudIconButton Color="Color.Primary" Icon="@Icons.Material.Filled.RemoveRedEye" Title="Xem danh sách chi tiết" OnClick="@(async()=>await OpenDialog(context.Item.Id.Value,context.Item.BookingTime.ToUniversalTime()))"></MudIconButton>
                    </MudButtonGroup>
                </span>
            </CellTemplate>
        </PropertyColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="BookingView" />
    </PagerContent>
</MudDataGrid>

@code {

    private List<BookingView> lstBookingServices = new List<BookingView>();
    bool _customizeGroupTemplate;
    static bool _customizeGroupBy;
    MudDataGrid<BookingView> dataGrid;

    [Inject]
    private IBookingViewServices _client { get; set; }
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        var respone = await _client.GetAll();
        lstBookingServices = respone.Data;
    }

    //group ngày
    private Func<BookingView, string> _groupBy = x =>
    {
        if (_customizeGroupBy)
        {
            return x.NameGuest;
        }
        else
        {
            return x.BookingTime.ToString("dd/MM/yyyy");
        }
    };
    void ExpandAllGroups()
    {
        dataGrid?.ExpandAllGroups();
    }


    private async Task OpenDialog(Guid id, DateTime dateBooking)
    {
        var parameters = new DialogParameters();
        string nameDialog = "Chi tiết khách đặt lịch";
        string id2 = Convert.ToString(id);
        DialogOptions options = new DialogOptions()
            {
                CloseOnEscapeKey = true,
                Position = DialogPosition.Center,
                MaxWidth = MaxWidth.Large,
                CloseButton = true,
                FullWidth = true,
                DisableBackdropClick = true
            };
        parameters.Add("id", id2);
        parameters.Add("dateBooking", dateBooking);
        var createUpdateDialog = await _dialogservice.ShowAsync<DetailsBooking>(nameDialog, parameters, options);
        var result = await createUpdateDialog.Result;
        if (!result.Canceled)
        {
            createUpdateDialog.Close();
            await LoadData();
        }
    }

        

        private async Task OpenDialogCreateBooking()
        {
        string nameDialog = "Đặt lịch tại quầy";
        DialogOptions options = new DialogOptions()
            {
                CloseOnEscapeKey = true,
                Position = DialogPosition.Center,
                MaxWidth = MaxWidth.Large,
                CloseButton = true,
                FullWidth = true,
                DisableBackdropClick = true
            };
        var createUpdateDialog = await _dialogservice.ShowAsync<CreateBookingCustomer>(nameDialog, options);
        var result = await createUpdateDialog.Result;
        if (!result.Canceled)
        {
            createUpdateDialog.Close();
            await LoadData();
        }
        }

}